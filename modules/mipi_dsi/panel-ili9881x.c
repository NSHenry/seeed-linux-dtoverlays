// SPDX-License-Identifier: GPL-2.0+
/*
 * ILI9881D panel driver
 * 
 * Copyright (c) 2020 Seeed Studio
 * Zhangqun Ming<north_sea@qq.com>
 * Modified by Hongtai Liu for compatibility with ILI9881C and ILI9881D
 */
#include "mipi_dsi.h"


static struct mipi_dsi_device *ili9881x_dsi = NULL;

static const struct drm_display_mode ili9881x_modes = {
	.clock		= 62712 /*73164*/ /*83616*/ /*94068*/ /*104520*/,

	.hdisplay	= 720,
	.hsync_start= 720 + 10,
	.hsync_end	= 720 + 10 + 20,
	.htotal		= 720 + 10 + 20 + 30,

	.vdisplay	= 1280,
	.vsync_start= 1280 + 10,
	.vsync_end	= 1280 + 10 + 20,
	.vtotal		= 1280 + 10 + 20 + 30,

	.width_mm	= 62,
	.height_mm	= 110,
};

// Panel type enum
enum ili9881_panel_type {
	ILI9881_UNKNOWN = 0,
	ILI9881D03,
	ILI9881D02,
	ILI9881C05,
};

static enum ili9881_panel_type panel_type = ILI9881_UNKNOWN;

#define ILI9881_PAGE(page) \
	mipi_dsi_dcs_write_buffer(dsi, (u8[]){0xFF, 0x98, 0x81, (page)}, 4)

#define ILI9881_COMMAND(cmd, ...) \
	do { \
		u8 data[] = { __VA_ARGS__ }; \
		mipi_dsi_dcs_write(dsi, (cmd), data, sizeof(data)); \
	} while (0)

// Read ID from page 1 registers 0xF0, 0xF1, 0xF2, 0xF4
static int ili9881_read_id(struct mipi_dsi_device *dsi)
{
	u8 id[4] = {0};
	int ret;

	// Try to detect ILI9881C first
	ret = ILI9881_PAGE(0x01);
	if (ret < 0) return ret;
	ret = mipi_dsi_dcs_read(dsi, 0x00, &id[0], 1);
	ret |= mipi_dsi_dcs_read(dsi, 0x01, &id[1], 1);
	ret |= mipi_dsi_dcs_read(dsi, 0x02, &id[2], 1);
	if (ret >= 0 && id[0] == 0x98 && id[1] == 0x81 && id[2] == 0x5C) {
		panel_type = ILI9881C05;
		pr_info("Detected ILI9881C05: ID = %02x %02x %02x\n", id[0], id[1], id[2]);
		return 0;
	}

	// If not ILI9881C, try to detect ILI9881D
	ret = ILI9881_PAGE(0x06);
	if (ret < 0) return ret;
	ret = mipi_dsi_dcs_read(dsi, 0xF0, &id[0], 1);
	ret |= mipi_dsi_dcs_read(dsi, 0xF1, &id[1], 1);
	ret |= mipi_dsi_dcs_read(dsi, 0xF2, &id[2], 1);
	ret |= mipi_dsi_dcs_read(dsi, 0xF3, &id[3], 1);
	if (ret >= 0 && id[0] == 0x98 && id[1] == 0x81) {
		if(id[2] == 0x1A){
			panel_type = ILI9881D03;
			pr_info("Detected ILI9881D03: ID = %02x %02x %02x %02x\n", id[0], id[1], id[2], id[3]);
		}else if(id[2] == 0x0D){
			panel_type = ILI9881D02;
			pr_info("Detected ILI9881D02: ID = %02x %02x %02x %02x\n", id[0], id[1], id[2], id[3]);
		}
		return 0;
	}

	panel_type = ILI9881_UNKNOWN;
	pr_warn("Unknown ILI9881 panel ID\n");
	return -ENODEV;
}

// Optional: Add ILI9881C05-specific initialization here
static void ili9881c05_init(struct mipi_dsi_device *dsi)
{
	pr_info("Initializing ILI9881C05 display...\n");
	ILI9881_PAGE(0x03);
	ILI9881_COMMAND(0x01, 0x00);
	ILI9881_COMMAND(0x02, 0x00);
	ILI9881_COMMAND(0x03, 0x73);
	ILI9881_COMMAND(0x04, 0x00);
	ILI9881_COMMAND(0x05, 0x00);
	ILI9881_COMMAND(0x06, 0x0A);
	ILI9881_COMMAND(0x07, 0x00);
	ILI9881_COMMAND(0x08, 0x00);
	ILI9881_COMMAND(0x09, 0x01);
	ILI9881_COMMAND(0x0A, 0x00);
	ILI9881_COMMAND(0x0B, 0x00);
	ILI9881_COMMAND(0x0C, 0x01);
	ILI9881_COMMAND(0x0D, 0x00);
	ILI9881_COMMAND(0x0E, 0x00);
	ILI9881_COMMAND(0x0F, 0x1D);
	ILI9881_COMMAND(0x10, 0x1D);
	ILI9881_COMMAND(0x11, 0x00);
	ILI9881_COMMAND(0x12, 0x00);
	ILI9881_COMMAND(0x13, 0x00);
	ILI9881_COMMAND(0x14, 0x00);
	ILI9881_COMMAND(0x15, 0x00);
	ILI9881_COMMAND(0x16, 0x00);
	ILI9881_COMMAND(0x17, 0x00);
	ILI9881_COMMAND(0x18, 0x00);
	ILI9881_COMMAND(0x19, 0x00);
	ILI9881_COMMAND(0x1A, 0x00);
	ILI9881_COMMAND(0x1B, 0x00);
	ILI9881_COMMAND(0x1C, 0x00);
	ILI9881_COMMAND(0x1D, 0x00);
	ILI9881_COMMAND(0x1E, 0x40);
	ILI9881_COMMAND(0x1F, 0x80);
	ILI9881_COMMAND(0x20, 0x06);
	ILI9881_COMMAND(0x21, 0x02);
	ILI9881_COMMAND(0x22, 0x00);
	ILI9881_COMMAND(0x23, 0x00);
	ILI9881_COMMAND(0x24, 0x00);
	ILI9881_COMMAND(0x25, 0x00);
	ILI9881_COMMAND(0x26, 0x00);
	ILI9881_COMMAND(0x27, 0x00);
	ILI9881_COMMAND(0x28, 0x33);
	ILI9881_COMMAND(0x29, 0x03);
	ILI9881_COMMAND(0x2A, 0x00);
	ILI9881_COMMAND(0x2B, 0x00);
	ILI9881_COMMAND(0x2C, 0x00);
	ILI9881_COMMAND(0x2D, 0x00);
	ILI9881_COMMAND(0x2E, 0x00);
	ILI9881_COMMAND(0x2F, 0x00);
	ILI9881_COMMAND(0x30, 0x00);
	ILI9881_COMMAND(0x31, 0x00);
	ILI9881_COMMAND(0x32, 0x00);
	ILI9881_COMMAND(0x33, 0x00);
	ILI9881_COMMAND(0x34, 0x04);
	ILI9881_COMMAND(0x35, 0x00);
	ILI9881_COMMAND(0x36, 0x00);
	ILI9881_COMMAND(0x37, 0x00);
	ILI9881_COMMAND(0x38, 0x3C);
	ILI9881_COMMAND(0x39, 0x00);
	ILI9881_COMMAND(0x3A, 0x40);
	ILI9881_COMMAND(0x3B, 0x40);
	ILI9881_COMMAND(0x3C, 0x00);
	ILI9881_COMMAND(0x3D, 0x00);
	ILI9881_COMMAND(0x3E, 0x00);
	ILI9881_COMMAND(0x3F, 0x00);
	ILI9881_COMMAND(0x40, 0x00);
	ILI9881_COMMAND(0x41, 0x00);
	ILI9881_COMMAND(0x42, 0x00);
	ILI9881_COMMAND(0x43, 0x00);
	ILI9881_COMMAND(0x44, 0x00);
	ILI9881_COMMAND(0x50, 0x01);
	ILI9881_COMMAND(0x51, 0x23);
	ILI9881_COMMAND(0x52, 0x45);
	ILI9881_COMMAND(0x53, 0x67);
	ILI9881_COMMAND(0x54, 0x89);
	ILI9881_COMMAND(0x55, 0xAB);
	ILI9881_COMMAND(0x56, 0x01);
	ILI9881_COMMAND(0x57, 0x23);
	ILI9881_COMMAND(0x58, 0x45);
	ILI9881_COMMAND(0x59, 0x67);
	ILI9881_COMMAND(0x5A, 0x89);
	ILI9881_COMMAND(0x5B, 0xAB);
	ILI9881_COMMAND(0x5C, 0xCD);
	ILI9881_COMMAND(0x5D, 0xEF);
	ILI9881_COMMAND(0x5E, 0x11);
	ILI9881_COMMAND(0x5F, 0x01);
	ILI9881_COMMAND(0x60, 0x00);
	ILI9881_COMMAND(0x61, 0x15);
	ILI9881_COMMAND(0x62, 0x14);
	ILI9881_COMMAND(0x63, 0x0E);
	ILI9881_COMMAND(0x64, 0x0F);
	ILI9881_COMMAND(0x65, 0x0C);
	ILI9881_COMMAND(0x66, 0x0D);
	ILI9881_COMMAND(0x67, 0x06);
	ILI9881_COMMAND(0x68, 0x02);
	ILI9881_COMMAND(0x69, 0x07);
	ILI9881_COMMAND(0x6A, 0x02);
	ILI9881_COMMAND(0x6B, 0x02);
	ILI9881_COMMAND(0x6C, 0x02);
	ILI9881_COMMAND(0x6D, 0x02);
	ILI9881_COMMAND(0x6E, 0x02);
	ILI9881_COMMAND(0x6F, 0x02);
	ILI9881_COMMAND(0x70, 0x02);
	ILI9881_COMMAND(0x71, 0x02);
	ILI9881_COMMAND(0x72, 0x02);
	ILI9881_COMMAND(0x73, 0x02);
	ILI9881_COMMAND(0x74, 0x02);
	ILI9881_COMMAND(0x75, 0x01);
	ILI9881_COMMAND(0x76, 0x00);
	ILI9881_COMMAND(0x77, 0x14);
	ILI9881_COMMAND(0x78, 0x15);
	ILI9881_COMMAND(0x79, 0x0E);
	ILI9881_COMMAND(0x7A, 0x0F);
	ILI9881_COMMAND(0x7B, 0x0C);
	ILI9881_COMMAND(0x7C, 0x0D);
	ILI9881_COMMAND(0x7D, 0x06);
	ILI9881_COMMAND(0x7E, 0x02);
	ILI9881_COMMAND(0x7F, 0x07);
	ILI9881_COMMAND(0x80, 0x02);
	ILI9881_COMMAND(0x81, 0x02);
	ILI9881_COMMAND(0x82, 0x02);
	ILI9881_COMMAND(0x83, 0x02);
	ILI9881_COMMAND(0x84, 0x02);
	ILI9881_COMMAND(0x85, 0x02);
	ILI9881_COMMAND(0x86, 0x02);
	ILI9881_COMMAND(0x87, 0x02);
	ILI9881_COMMAND(0x88, 0x02);
	ILI9881_COMMAND(0x89, 0x02);
	ILI9881_COMMAND(0x8A, 0x02);
	ILI9881_PAGE(0x04);
	ILI9881_COMMAND(0x38, 0x01);
	ILI9881_COMMAND(0x39, 0x00);
	ILI9881_COMMAND(0x6C, 0x15);
	ILI9881_COMMAND(0x6E, 0x2B);
	ILI9881_COMMAND(0x6F, 0x33);
	ILI9881_COMMAND(0x8D, 0x18);
	ILI9881_COMMAND(0x87, 0xBA);
	ILI9881_COMMAND(0x26, 0x76);
	ILI9881_COMMAND(0xB2, 0xD1);
	ILI9881_COMMAND(0xB5, 0x06);
	ILI9881_COMMAND(0x3A, 0x24);
	ILI9881_COMMAND(0x35, 0x1F);
	ILI9881_COMMAND(0x33, 0x14);
	ILI9881_COMMAND(0x3B, 0x98);
	ILI9881_PAGE(0x01);
	ILI9881_COMMAND(0x22, 0x0A);
	ILI9881_COMMAND(0x31, 0x00);
	ILI9881_COMMAND(0x40, 0x33);
	ILI9881_COMMAND(0x53, 0xA8);
	ILI9881_COMMAND(0x55, 0xB8);
	ILI9881_COMMAND(0x50, 0x96);
	ILI9881_COMMAND(0x51, 0x96);
	ILI9881_COMMAND(0x60, 0x22);
	ILI9881_COMMAND(0x61, 0x00);
	ILI9881_COMMAND(0x62, 0x19);
	ILI9881_COMMAND(0x63, 0x00);
	ILI9881_COMMAND(0xA0, 0x08);
	ILI9881_COMMAND(0xA1, 0x11);
	ILI9881_COMMAND(0xA2, 0x19);
	ILI9881_COMMAND(0xA3, 0x0D);
	ILI9881_COMMAND(0xA4, 0x0D);
	ILI9881_COMMAND(0xA5, 0x1E);
	ILI9881_COMMAND(0xA6, 0x14);
	ILI9881_COMMAND(0xA7, 0x17);
	ILI9881_COMMAND(0xA8, 0x4F);
	ILI9881_COMMAND(0xA9, 0x1A);
	ILI9881_COMMAND(0xAA, 0x27);
	ILI9881_COMMAND(0xAB, 0x49);
	ILI9881_COMMAND(0xAC, 0x1A);
	ILI9881_COMMAND(0xAD, 0x18);
	ILI9881_COMMAND(0xAE, 0x4C);
	ILI9881_COMMAND(0xAF, 0x22);
	ILI9881_COMMAND(0xB0, 0x27);
	ILI9881_COMMAND(0xB1, 0x4B);
	ILI9881_COMMAND(0xB2, 0x60);
	ILI9881_COMMAND(0xB3, 0x39);
	ILI9881_COMMAND(0xC0, 0x08);
	ILI9881_COMMAND(0xC1, 0x11);
	ILI9881_COMMAND(0xC2, 0x19);
	ILI9881_COMMAND(0xC3, 0x0D);
	ILI9881_COMMAND(0xC4, 0x0D);
	ILI9881_COMMAND(0xC5, 0x1E);
	ILI9881_COMMAND(0xC6, 0x14);
	ILI9881_COMMAND(0xC7, 0x17);
	ILI9881_COMMAND(0xC8, 0x4F);
	ILI9881_COMMAND(0xC9, 0x1A);
	ILI9881_COMMAND(0xCA, 0x27);
	ILI9881_COMMAND(0xCB, 0x49);
	ILI9881_COMMAND(0xCC, 0x1A);
	ILI9881_COMMAND(0xCD, 0x18);
	ILI9881_COMMAND(0xCE, 0x4C);
	ILI9881_COMMAND(0xCF, 0x33);
	ILI9881_COMMAND(0xD0, 0x27);
	ILI9881_COMMAND(0xD1, 0x4B);
	ILI9881_COMMAND(0xD2, 0x60);
	ILI9881_COMMAND(0xD3, 0x39);
	ILI9881_PAGE(0x00);
	ILI9881_COMMAND(0x36, 0x00);
	ILI9881_COMMAND(0x35, 0x00);
	ILI9881_COMMAND(0x11); // Sleep Out
	msleep(120);
	ILI9881_COMMAND(0x29); // Display On
	msleep(40);
}

// Optional: Add ILI9881D02-specific initialization here
static void ili9881d02_init(struct mipi_dsi_device *dsi)
{
	pr_info("Initializing ILI9881D02 display...\n");
	
	// Page 0x03
	ILI9881_PAGE(0x03);
	ILI9881_COMMAND(0x01, 0x00);
	ILI9881_COMMAND(0x02, 0x00);
	ILI9881_COMMAND(0x03, 0x73);
	ILI9881_COMMAND(0x04, 0x00);
	ILI9881_COMMAND(0x05, 0x00);
	ILI9881_COMMAND(0x06, 0x0A);
	ILI9881_COMMAND(0x07, 0x00);
	ILI9881_COMMAND(0x08, 0x00);
	ILI9881_COMMAND(0x09, 0x01);
	ILI9881_COMMAND(0x0A, 0x01); // Modified from 0x00
	ILI9881_COMMAND(0x0B, 0x00);
	ILI9881_COMMAND(0x0C, 0x01);
	ILI9881_COMMAND(0x0D, 0x00);
	ILI9881_COMMAND(0x0E, 0x00);
	ILI9881_COMMAND(0x0F, 0x1D);
	ILI9881_COMMAND(0x10, 0x01); // Modified from 0x1D
	ILI9881_COMMAND(0x11, 0x00);
	ILI9881_COMMAND(0x12, 0x00);
	ILI9881_COMMAND(0x13, 0x00);
	ILI9881_COMMAND(0x14, 0x00);
	ILI9881_COMMAND(0x15, 0x00);
	ILI9881_COMMAND(0x16, 0x00);
	ILI9881_COMMAND(0x17, 0x00);
	ILI9881_COMMAND(0x18, 0x00);
	ILI9881_COMMAND(0x19, 0x00);
	ILI9881_COMMAND(0x1A, 0x00);
	ILI9881_COMMAND(0x1B, 0x00);
	ILI9881_COMMAND(0x1C, 0x00);
	ILI9881_COMMAND(0x1D, 0x00);
	ILI9881_COMMAND(0x1E, 0x40);
	ILI9881_COMMAND(0x1F, 0x80);
	ILI9881_COMMAND(0x20, 0x06);
	ILI9881_COMMAND(0x21, 0x02);
	ILI9881_COMMAND(0x22, 0x00);
	ILI9881_COMMAND(0x23, 0x00);
	ILI9881_COMMAND(0x24, 0x00);
	ILI9881_COMMAND(0x25, 0x00);
	ILI9881_COMMAND(0x26, 0x00);
	ILI9881_COMMAND(0x27, 0x00);
	ILI9881_COMMAND(0x28, 0x33);
	ILI9881_COMMAND(0x29, 0x03);
	ILI9881_COMMAND(0x2A, 0x00);
	ILI9881_COMMAND(0x2B, 0x00);
	ILI9881_COMMAND(0x2C, 0x00);
	ILI9881_COMMAND(0x2D, 0x00);
	ILI9881_COMMAND(0x2E, 0x00);
	ILI9881_COMMAND(0x2F, 0x00);
	ILI9881_COMMAND(0x30, 0x00);
	ILI9881_COMMAND(0x31, 0x00);
	ILI9881_COMMAND(0x32, 0x00);
	ILI9881_COMMAND(0x33, 0x00);
	ILI9881_COMMAND(0x34, 0x04);
	ILI9881_COMMAND(0x35, 0x00);
	ILI9881_COMMAND(0x36, 0x00);
	ILI9881_COMMAND(0x37, 0x00);
	ILI9881_COMMAND(0x38, 0x3C);
	ILI9881_COMMAND(0x39, 0x35); // Modified from 0x00
	ILI9881_COMMAND(0x3A, 0x01);  // Modified from 0x40
	ILI9881_COMMAND(0x3B, 0x40);
	ILI9881_COMMAND(0x3C, 0x00);
	ILI9881_COMMAND(0x3D, 0x01);  // Modified from 0x00
	ILI9881_COMMAND(0x3E, 0x00);
	ILI9881_COMMAND(0x3F, 0x00);
	ILI9881_COMMAND(0x40, 0x00);
	ILI9881_COMMAND(0x41, 0x88); // Modified from 0x00
	ILI9881_COMMAND(0x42, 0x00);
	ILI9881_COMMAND(0x43, 0x00);
	ILI9881_COMMAND(0x44, 0x1F); // Modified from 0x00
	ILI9881_COMMAND(0x50, 0x01);
	ILI9881_COMMAND(0x51, 0x23);
	ILI9881_COMMAND(0x52, 0x45);
	ILI9881_COMMAND(0x53, 0x67);
	ILI9881_COMMAND(0x54, 0x89);
	ILI9881_COMMAND(0x55, 0xAB);
	ILI9881_COMMAND(0x56, 0x01);
	ILI9881_COMMAND(0x57, 0x23);
	ILI9881_COMMAND(0x58, 0x45);
	ILI9881_COMMAND(0x59, 0x67);
	ILI9881_COMMAND(0x5A, 0x89);
	ILI9881_COMMAND(0x5B, 0xAB);
	ILI9881_COMMAND(0x5C, 0xCD);
	ILI9881_COMMAND(0x5D, 0xEF);
	ILI9881_COMMAND(0x5E, 0x11);
	ILI9881_COMMAND(0x5F, 0x01);
	ILI9881_COMMAND(0x60, 0x00);
	ILI9881_COMMAND(0x61, 0x15);
	ILI9881_COMMAND(0x62, 0x14);
	ILI9881_COMMAND(0x63, 0x0E);
	ILI9881_COMMAND(0x64, 0x0F);
	ILI9881_COMMAND(0x65, 0x0C);
	ILI9881_COMMAND(0x66, 0x0D);
	ILI9881_COMMAND(0x67, 0x06);
	ILI9881_COMMAND(0x68, 0x02);
	ILI9881_COMMAND(0x69, 0x07);
	ILI9881_COMMAND(0x6A, 0x02);
	ILI9881_COMMAND(0x6B, 0x02);
	ILI9881_COMMAND(0x6C, 0x02);
	ILI9881_COMMAND(0x6D, 0x02);
	ILI9881_COMMAND(0x6E, 0x02);
	ILI9881_COMMAND(0x6F, 0x02);
	ILI9881_COMMAND(0x70, 0x02);
	ILI9881_COMMAND(0x71, 0x02);
	ILI9881_COMMAND(0x72, 0x02);
	ILI9881_COMMAND(0x73, 0x02);
	ILI9881_COMMAND(0x74, 0x02);
	ILI9881_COMMAND(0x75, 0x01);
	ILI9881_COMMAND(0x76, 0x00);
	ILI9881_COMMAND(0x77, 0x14);
	ILI9881_COMMAND(0x78, 0x15);
	ILI9881_COMMAND(0x79, 0x0E);
	ILI9881_COMMAND(0x7A, 0x0F);
	ILI9881_COMMAND(0x7B, 0x0C);
	ILI9881_COMMAND(0x7C, 0x0D);
	ILI9881_COMMAND(0x7D, 0x06);
	ILI9881_COMMAND(0x7E, 0x02);
	ILI9881_COMMAND(0x7F, 0x07);
	ILI9881_COMMAND(0x80, 0x02);
	ILI9881_COMMAND(0x81, 0x02);
	ILI9881_COMMAND(0x82, 0x02);
	ILI9881_COMMAND(0x83, 0x02);
	ILI9881_COMMAND(0x84, 0x02);
	ILI9881_COMMAND(0x85, 0x02);
	ILI9881_COMMAND(0x86, 0x02);
	ILI9881_COMMAND(0x87, 0x02);
	ILI9881_COMMAND(0x88, 0x02);
	ILI9881_COMMAND(0x89, 0x02);
	ILI9881_COMMAND(0x8A, 0x02);

	// Page 0x04
	ILI9881_PAGE(0x04);
	ILI9881_COMMAND(0x70, 0x00);
	ILI9881_COMMAND(0x71, 0x00);
	ILI9881_COMMAND(0x82, 0x0F); // VGH_MOD clamp level = 15V
	ILI9881_COMMAND(0x84, 0x0F); // VGH clamp level = 15V
	ILI9881_COMMAND(0x85, 0x0D); // VGL clamp level = -10V
	ILI9881_COMMAND(0x32, 0xAC);
	ILI9881_COMMAND(0x8C, 0x80);
	ILI9881_COMMAND(0x3C, 0xF5);
	ILI9881_COMMAND(0xB5, 0x07); // Gamma OP
	ILI9881_COMMAND(0x31, 0x45); // Source OP
	ILI9881_COMMAND(0x3A, 0x24); // PS_EN OFF
	ILI9881_COMMAND(0x88, 0x33);

	// Page 0x01
	ILI9881_PAGE(0x01);
	ILI9881_COMMAND(0x22, 0x09); // BGR, SS, GS settings
	ILI9881_COMMAND(0x31, 0x00); // Column inversion
	ILI9881_COMMAND(0x53, 0x8A); // VCOM1
	ILI9881_COMMAND(0x55, 0xA2); // VCOM2
	ILI9881_COMMAND(0x50, 0x81); // VREG1OUT = 5V
	ILI9881_COMMAND(0x51, 0x85); // VREG2OUT = -5V
	ILI9881_COMMAND(0x62, 0x0D); // EQT Time setting

	// Gamma settings (Page 0x01 repeated for clarity, as in original)
	ILI9881_PAGE(0x01);
	ILI9881_COMMAND(0xA0, 0x00);
	ILI9881_COMMAND(0xA1, 0x1A);
	ILI9881_COMMAND(0xA2, 0x28);
	ILI9881_COMMAND(0xA3, 0x13);
	ILI9881_COMMAND(0xA4, 0x16);
	ILI9881_COMMAND(0xA5, 0x29);
	ILI9881_COMMAND(0xA6, 0x1D);
	ILI9881_COMMAND(0xA7, 0x1E);
	ILI9881_COMMAND(0xA8, 0x84);
	ILI9881_COMMAND(0xA9, 0x1C);
	ILI9881_COMMAND(0xAA, 0x28);
	ILI9881_COMMAND(0xAB, 0x75);
	ILI9881_COMMAND(0xAC, 0x1A);
	ILI9881_COMMAND(0xAD, 0x19);
	ILI9881_COMMAND(0xAE, 0x4D);
	ILI9881_COMMAND(0xAF, 0x22);
	ILI9881_COMMAND(0xB0, 0x28);
	ILI9881_COMMAND(0xB1, 0x54);
	ILI9881_COMMAND(0xB2, 0x66);
	ILI9881_COMMAND(0xB3, 0x39);
	ILI9881_COMMAND(0xC0, 0x00);
	ILI9881_COMMAND(0xC1, 0x1A);
	ILI9881_COMMAND(0xC2, 0x28);
	ILI9881_COMMAND(0xC3, 0x13);
	ILI9881_COMMAND(0xC4, 0x16);
	ILI9881_COMMAND(0xC5, 0x29);
	ILI9881_COMMAND(0xC6, 0x1D);
	ILI9881_COMMAND(0xC7, 0x1E);
	ILI9881_COMMAND(0xC8, 0x84);
	ILI9881_COMMAND(0xC9, 0x1C);
	ILI9881_COMMAND(0xCA, 0x28);
	ILI9881_COMMAND(0xCB, 0x75);
	ILI9881_COMMAND(0xCC, 0x1A);
	ILI9881_COMMAND(0xCD, 0x19);
	ILI9881_COMMAND(0xCE, 0x4D);
	ILI9881_COMMAND(0xCF, 0x22);
	ILI9881_COMMAND(0xD0, 0x28);
	ILI9881_COMMAND(0xD1, 0x54);
	ILI9881_COMMAND(0xD2, 0x66);
	ILI9881_COMMAND(0xD3, 0x39);

	// Page 0x00
	ILI9881_PAGE(0x00);
	ILI9881_COMMAND(0x35, 0x00); // TE on (commented out as in original)
	ILI9881_COMMAND(0x36, 0x03);
	ILI9881_COMMAND(0x11); // Sleep Out
	msleep(120); // Wait 120ms
	ILI9881_COMMAND(0x29); // Display On
	msleep(40); // Wait 40ms
}

// Optional: Add ILI9881D03-specific initialization here
static void ili9881d03_init(struct mipi_dsi_device *dsi)
{
	pr_info("Initializing ILI9881D03 display...\n");

	ILI9881_PAGE(0x01);           
	ILI9881_COMMAND(0x91,0x00);
	ILI9881_COMMAND(0x92,0x00);
	ILI9881_COMMAND(0x93,0x72);
	ILI9881_COMMAND(0x94,0x00);
	ILI9881_COMMAND(0x95,0x00);
	ILI9881_COMMAND(0x96,0x09);
	ILI9881_COMMAND(0x97,0x00);
	ILI9881_COMMAND(0x98,0x00);

	ILI9881_COMMAND(0x09,0x01);
	ILI9881_COMMAND(0x0a,0x00);
	ILI9881_COMMAND(0x0b,0x00);
	ILI9881_COMMAND(0x0c,0x01);
	ILI9881_COMMAND(0x0d,0x00);
	ILI9881_COMMAND(0x0e,0x00);
	ILI9881_COMMAND(0x0f,0x1D);
	ILI9881_COMMAND(0x10,0x1D);
	ILI9881_COMMAND(0x11,0x00);
	ILI9881_COMMAND(0x12,0x00);
	ILI9881_COMMAND(0x13,0x00);
	ILI9881_COMMAND(0x14,0x00);
	ILI9881_COMMAND(0x15,0x00);
	ILI9881_COMMAND(0x16,0x00);
	ILI9881_COMMAND(0x17,0x00);
	ILI9881_COMMAND(0x18,0x00);
	ILI9881_COMMAND(0x19,0x00);
	ILI9881_COMMAND(0x1a,0x00);
	ILI9881_COMMAND(0x1b,0x00);
	ILI9881_COMMAND(0x1c,0x00);
	ILI9881_COMMAND(0x1d,0x00);
	ILI9881_COMMAND(0x1e,0xc0);
	ILI9881_COMMAND(0x1f,0x00);
	ILI9881_COMMAND(0x20,0x06);
	ILI9881_COMMAND(0x21,0x02);
	ILI9881_COMMAND(0x22,0x00);
	ILI9881_COMMAND(0x23,0x00);
	ILI9881_COMMAND(0x24,0x00);
	ILI9881_COMMAND(0x25,0x00);
	ILI9881_COMMAND(0x26,0x00);
	ILI9881_COMMAND(0x27,0x00);
	ILI9881_COMMAND(0x28,0x33);
	ILI9881_COMMAND(0x29,0x03);
	ILI9881_COMMAND(0x2a,0x00);
	ILI9881_COMMAND(0x2b,0x00);
	ILI9881_COMMAND(0x2c,0x00);
	ILI9881_COMMAND(0x2d,0x00);
	ILI9881_COMMAND(0x2e,0x00);
	ILI9881_COMMAND(0x2f,0x00);
	ILI9881_COMMAND(0x30,0x00);
	ILI9881_COMMAND(0x31,0x00);
	ILI9881_COMMAND(0x32,0x00);
	ILI9881_COMMAND(0x33,0x00);
	ILI9881_COMMAND(0x34,0x04);
	ILI9881_COMMAND(0x35,0x00);
	ILI9881_COMMAND(0x36,0x00);
	ILI9881_COMMAND(0x37,0x00);
	ILI9881_COMMAND(0x38,0x3C);
	ILI9881_COMMAND(0x39,0x07);
	ILI9881_COMMAND(0x3a,0x00);
	ILI9881_COMMAND(0x3b,0x00);
	ILI9881_COMMAND(0x3c,0x00);

	ILI9881_COMMAND(0x40,0x03);
	ILI9881_COMMAND(0x41,0x20);
	ILI9881_COMMAND(0x42,0x00);
	ILI9881_COMMAND(0x43,0x00);
	ILI9881_COMMAND(0x44,0x03);
	ILI9881_COMMAND(0x45,0x00);
	ILI9881_COMMAND(0x46,0x01);
	ILI9881_COMMAND(0x47,0x08);
	ILI9881_COMMAND(0x48,0x00);
	ILI9881_COMMAND(0x49,0x00);
	ILI9881_COMMAND(0x4a,0x00);
	ILI9881_COMMAND(0x4b,0x00);

	// ==== GL[3OUT=
	ILI9881_COMMAND(0x4c,0x01);
	ILI9881_COMMAND(0x4d,0x54);
	ILI9881_COMMAND(0x4e,0x57);
	ILI9881_COMMAND(0x4f,0x9b);
	ILI9881_COMMAND(0x50,0xf9);
	ILI9881_COMMAND(0x51,0x27);
	ILI9881_COMMAND(0x52,0x2f);
	ILI9881_COMMAND(0x53,0xf2);
	ILI9881_COMMAND(0x54,0xff);
	ILI9881_COMMAND(0x55,0xff);
	ILI9881_COMMAND(0x56,0xff);

	// ==== GR[3OUT==
	ILI9881_COMMAND(0x57,0x01);
	ILI9881_COMMAND(0x58,0x54);
	ILI9881_COMMAND(0x59,0x46);
	ILI9881_COMMAND(0x5a,0x8a);
	ILI9881_COMMAND(0x5b,0xf8);
	ILI9881_COMMAND(0x5c,0x26);
	ILI9881_COMMAND(0x5d,0x2f);
	ILI9881_COMMAND(0x5e,0xf2);
	ILI9881_COMMAND(0x5f,0xff);
	ILI9881_COMMAND(0x60,0xff);
	ILI9881_COMMAND(0x61,0xff);

	ILI9881_COMMAND(0x62,0x06);

	// == GOUT:4]_BWUTL[5:0]==
	ILI9881_COMMAND(0x63,0x01);
	ILI9881_COMMAND(0x64,0x00);
	ILI9881_COMMAND(0x65,0xa4);
	ILI9881_COMMAND(0x66,0xa5);
	ILI9881_COMMAND(0x67,0x58);
	ILI9881_COMMAND(0x68,0x5a);
	ILI9881_COMMAND(0x69,0x54);
	ILI9881_COMMAND(0x6a,0x56);
	ILI9881_COMMAND(0x6b,0x06);
	ILI9881_COMMAND(0x6c,0xff);
	ILI9881_COMMAND(0x6d,0x08);
	ILI9881_COMMAND(0x6e,0x02);
	ILI9881_COMMAND(0x6f,0xff);
	ILI9881_COMMAND(0x70,0x02);
	ILI9881_COMMAND(0x71,0x02);
	ILI9881_COMMAND(0x72,0xff);
	ILI9881_COMMAND(0x73,0xff);
	ILI9881_COMMAND(0x74,0xff);
	ILI9881_COMMAND(0x75,0xff);
	ILI9881_COMMAND(0x76,0xff);
	ILI9881_COMMAND(0x77,0xff);
	ILI9881_COMMAND(0x78,0xff);

	// == GOUT:4]_BWUTR[5:0]==
	ILI9881_COMMAND(0x79,0x01);
	ILI9881_COMMAND(0x7a,0x00);
	ILI9881_COMMAND(0x7b,0xa4);
	ILI9881_COMMAND(0x7c,0xa5);
	ILI9881_COMMAND(0x7d,0x59);
	ILI9881_COMMAND(0x7e,0x5b);
	ILI9881_COMMAND(0x7f,0x55);
	ILI9881_COMMAND(0x80,0x57);
	ILI9881_COMMAND(0x81,0x07);
	ILI9881_COMMAND(0x82,0xff);
	ILI9881_COMMAND(0x83,0x09);
	ILI9881_COMMAND(0x84,0x02);
	ILI9881_COMMAND(0x85,0xff);
	ILI9881_COMMAND(0x86,0x02);
	ILI9881_COMMAND(0x87,0x02);
	ILI9881_COMMAND(0x88,0xff);
	ILI9881_COMMAND(0x89,0xff);
	ILI9881_COMMAND(0x8a,0xff);
	ILI9881_COMMAND(0x8b,0xff);
	ILI9881_COMMAND(0x8c,0xff);
	ILI9881_COMMAND(0x8d,0xff);
	ILI9881_COMMAND(0x8e,0xff);

	ILI9881_COMMAND(0x8f,0x00);
	ILI9881_COMMAND(0x90,0x00);

	ILI9881_COMMAND(0x9d,0x00);
	ILI9881_COMMAND(0x9e,0x00);

	ILI9881_COMMAND(0xa0,0x35);
	ILI9881_COMMAND(0xa1,0x00);
	ILI9881_COMMAND(0xa2,0x00);
	ILI9881_COMMAND(0xa3,0x00);
	ILI9881_COMMAND(0xa4,0x00);
	ILI9881_COMMAND(0xa5,0x00);
	ILI9881_COMMAND(0xa6,0x08);
	ILI9881_COMMAND(0xa7,0x00);
	ILI9881_COMMAND(0xa8,0x00);
	ILI9881_COMMAND(0xa9,0x00);
	ILI9881_COMMAND(0xaa,0x00);
	ILI9881_COMMAND(0xab,0x00);
	ILI9881_COMMAND(0xac,0x00);
	ILI9881_COMMAND(0xad,0x00);
	ILI9881_COMMAND(0xae,0xff);
	ILI9881_COMMAND(0xaf,0x00);
	ILI9881_COMMAND(0xb0,0x00);

	ILI9881_PAGE(0x02);
	ILI9881_COMMAND(0x08,0x11);
	ILI9881_COMMAND(0x0a,0x0c);
	ILI9881_COMMAND(0x0f,0x06);
	ILI9881_COMMAND(0xA0,0x00,0x26,0x35,0x16,0x19,0x2C,0x1F,0x1F,0x96,0x1C,0x28,0x80,0x1A,0x18,0x4C,0x21,0x27,0x55,0x65,0x39);
	ILI9881_COMMAND(0xC0,0x00,0x26,0x35,0x16,0x19,0x2C,0x1F,0x1F,0x96,0x1C,0x28,0x80,0x1A,0x18,0x4C,0x21,0x27,0x55,0x65,0x39);

	//===== GIP code finish =====//
	ILI9881_COMMAND(0x4C,0xA4); // PS_EN on ,0x default :A4
	ILI9881_COMMAND(0x18,0xF4); // SH on ,0x default E4 

	//=========================//
	ILI9881_PAGE(0x04);
	ILI9881_COMMAND(0x5D,0xAF); // VREG1 5.5V 
	ILI9881_COMMAND(0x5E,0xAF); // VREG2 5.5V
	ILI9881_COMMAND(0x60,0x9B); // VCM1 
	ILI9881_COMMAND(0x62,0x9B); // VCM2 
	ILI9881_COMMAND(0x82,0x38); // VREF_VGH_MOD_CLPSEL 16V 
	ILI9881_COMMAND(0x84,0x38); // VREF_VGH_DC 16V     
	ILI9881_COMMAND(0x86,0x18); // VREF_VGL_CLPSEL -10V       
	ILI9881_COMMAND(0x66,0xC4); // VGH_AC x4 ,0xdefault :04
	ILI9881_COMMAND(0xC1,0xF0); // VGH_DC x4 ,0xdefault :70
	ILI9881_COMMAND(0x70,0x60);
	ILI9881_COMMAND(0x71,0x00);

	//=========================//
	ILI9881_COMMAND(0x5B,0x33); // vcore_sel Voltage
	ILI9881_COMMAND(0x6C,0x10); // vcore bias L
	ILI9881_COMMAND(0x77,0x03); // vcore_sel Voltage
	ILI9881_COMMAND(0x7B,0x02); // vcore bias R

	//=========================//
	ILI9881_PAGE(0x01);
	ILI9881_COMMAND(0xF0,0x00); // 1280 Gate NL
	ILI9881_COMMAND(0xF1,0xC8); // 1280 Gate NL

	ILI9881_PAGE(0x05);
	ILI9881_COMMAND(0x22,0x3A); // RGB to BGR

	ILI9881_PAGE(0x00);     
	ILI9881_COMMAND(0x35,0x00);        

	ILI9881_COMMAND(0x11); // Sleep Out
	msleep(120);
	ILI9881_COMMAND(0x29); // Display On
	msleep(40);
}



// Called before enabling the panel
static int ili9881x_prepare(struct drm_panel *panel)
{
	struct mipi_dsi_device *dsi = ili9881x_dsi;
	int ret;

	if (!dsi) return -ENODEV;

	// Detect panel type by reading ID
	ret = ili9881_read_id(dsi);
	if (ret < 0) {
		pr_err("Failed to read ILI9881 ID\n");
		return ret;
	}

	switch (panel_type) {
	case ILI9881D02:
		ili9881d02_init(dsi);
		break;
	case ILI9881D03:
		ili9881d03_init(dsi);
		break;
	case ILI9881C05:
		ili9881c05_init(dsi);
		break;
	default:
		pr_warn("Unknown ILI9881 panel type\n");
		return -ENODEV;
	}

	return 0;
}

// Called to turn off the panel
static int ili9881x_unprepare(struct drm_panel *panel)
{
	if (ili9881x_dsi)
		mipi_dsi_dcs_enter_sleep_mode(ili9881x_dsi);
	return 0;
}

static int ili9881x_get_modes(struct drm_panel *panel, struct drm_connector *connector)
{
	struct drm_display_mode *mode;

	mode = drm_mode_duplicate(connector->dev, &ili9881x_modes);
	if (!mode)
		return -ENOMEM;

	mode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;
	drm_mode_set_name(mode);
	connector->display_info.width_mm = mode->width_mm;
	connector->display_info.height_mm = mode->height_mm;
	drm_mode_probed_add(connector, mode);
	drm_connector_set_panel_orientation(connector, DRM_MODE_PANEL_ORIENTATION_RIGHT_UP);
	return 1;
}

static const struct drm_panel_funcs ili9881x_funcs = {
	.get_modes = ili9881x_get_modes,
	.prepare = ili9881x_prepare,
	.unprepare = ili9881x_unprepare,
};

static void ili9881x_set_dsi(struct mipi_dsi_device *dsi)
{
	ili9881x_dsi = dsi;
}

const struct panel_data ili9881x_data = {
	.set_dsi = ili9881x_set_dsi,
	.funcs = &ili9881x_funcs,
};
